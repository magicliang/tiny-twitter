# 架构图

本文档包含了Twitter克隆应用的各种架构图和可视化表示。

## 目录

1. [系统架构概览](#系统架构概览)
2. [数据库架构](#数据库架构)
3. [API架构](#api架构)
4. [安全架构](#安全架构)
5. [部署架构](#部署架构)
6. [数据流图](#数据流图)
7. [组件交互图](#组件交互图)

## 系统架构概览

### 高层架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端客户端     │    │   Spring Boot   │    │     数据库      │
│   (Web/Mobile)  │◄──►│   应用服务器     │◄──►│   (H2/MySQL)   │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   外部服务      │
                       │ (文件存储等)    │
                       └─────────────────┘
```

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        表示层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   REST API      │  │   Web界面       │  │   移动端API     ││
│  │   控制器        │  │   (可选)        │  │   (可选)        ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                        业务层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   用户服务      │  │   推文服务      │  │   认证服务      ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                        数据访问层                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   用户仓库      │  │   推文仓库      │  │   关注仓库      ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│                    H2数据库 (开发)                           │
│                   MySQL数据库 (生产)                         │
└─────────────────────────────────────────────────────────────┘
```

## 数据库架构

### 实体关系图 (ERD)

```
┌─────────────────┐         ┌─────────────────┐
│     Users       │         │     Tweets      │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │◄────────┤ id (PK)         │
│ username        │         │ user_id (FK)    │
│ email           │         │ content         │
│ password        │         │ created_at      │
│ created_at      │         │ updated_at      │
│ updated_at      │         └─────────────────┘
│ bio             │                   │
│ profile_image   │                   │
└─────────────────┘                   │
         │                            │
         │                            │
         ▼                            ▼
┌─────────────────┐         ┌─────────────────┐
│  User_Follows   │         │   User_Likes    │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ follower_id(FK) │         │ user_id (FK)    │
│ following_id(FK)│         │ tweet_id (FK)   │
│ created_at      │         │ created_at      │
└─────────────────┘         └─────────────────┘
```

### 数据库表结构

#### Users表
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    bio TEXT,
    profile_image VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### Tweets表
```sql
CREATE TABLE tweets (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### User_Follows表
```sql
CREATE TABLE user_follows (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    follower_id BIGINT NOT NULL,
    following_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (follower_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (following_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_follow (follower_id, following_id)
);
```

#### User_Likes表
```sql
CREATE TABLE user_likes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    tweet_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (tweet_id) REFERENCES tweets(id) ON DELETE CASCADE,
    UNIQUE KEY unique_like (user_id, tweet_id)
);
```

## API架构

### REST API端点结构

```
/api
├── /auth
│   ├── POST /register     # 用户注册
│   ├── POST /login        # 用户登录
│   └── POST /logout       # 用户登出
├── /users
│   ├── GET /{id}          # 获取用户信息
│   ├── PUT /{id}          # 更新用户信息
│   ├── GET /{id}/tweets   # 获取用户推文
│   ├── GET /{id}/followers # 获取关注者
│   ├── GET /{id}/following # 获取关注的人
│   ├── POST /{id}/follow   # 关注用户
│   └── DELETE /{id}/follow # 取消关注
├── /tweets
│   ├── GET /              # 获取推文时间线
│   ├── POST /             # 创建推文
│   ├── GET /{id}          # 获取特定推文
│   ├── DELETE /{id}       # 删除推文
│   ├── POST /{id}/like    # 点赞推文
│   └── DELETE /{id}/like  # 取消点赞
└── /timeline
    ├── GET /home          # 获取主页时间线
    └── GET /user/{id}     # 获取用户时间线
```

### API请求/响应流程

```
客户端请求 → 安全过滤器 → 控制器 → 服务层 → 数据访问层 → 数据库
     ↓           ↓          ↓        ↓         ↓           ↓
客户端响应 ← JSON序列化 ← DTO转换 ← 业务逻辑 ← 实体映射 ← 查询结果
```

## 安全架构

### JWT认证流程

```
┌─────────────┐    1. 登录请求     ┌─────────────────┐
│   客户端    │──────────────────►│  认证控制器     │
└─────────────┘                   └─────────────────┘
       ▲                                   │
       │                                   │ 2. 验证凭据
       │                                   ▼
       │                          ┌─────────────────┐
       │                          │   用户服务      │
       │                          └─────────────────┘
       │                                   │
       │ 4. 返回JWT令牌                     │ 3. 生成JWT
       │                                   ▼
       │                          ┌─────────────────┐
       └──────────────────────────│   JWT工具类     │
                                  └─────────────────┘

后续请求流程:
┌─────────────┐   带JWT的请求    ┌─────────────────┐
│   客户端    │─────────────────►│  JWT过滤器      │
└─────────────┘                  └─────────────────┘
                                          │
                                          │ 验证JWT
                                          ▼
                                 ┌─────────────────┐
                                 │   控制器        │
                                 └─────────────────┘
```

### 安全层级

```
┌─────────────────────────────────────────────────────────────┐
│                      HTTPS/TLS层                            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Spring Security                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   CORS配置      │  │   JWT过滤器     │  │   认证管理器    ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      应用层安全                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   输入验证      │  │   权限检查      │  │   数据加密      ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 部署架构

### 开发环境

```
┌─────────────────────────────────────────────────────────────┐
│                      开发机器                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   IDE           │  │  Spring Boot    │  │   H2数据库      ││
│  │  (IntelliJ)     │  │   应用          │  │  (内存模式)     ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 生产环境 (建议)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器    │    │   应用服务器    │    │     数据库      │
│   (Nginx)       │◄──►│  Spring Boot    │◄──►│    MySQL        │
│                 │    │   实例 1        │    │   主从复制      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                       ┌─────────────────┐
                       │  Spring Boot    │
                       │   实例 2        │
                       └─────────────────┘
```

### 容器化部署

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker环境                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │  应用容器       │  │  数据库容器     │  │  Redis容器      ││
│  │ (Spring Boot)   │  │   (MySQL)       │  │  (缓存)         ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 数据流图

### 用户注册流程

```
用户输入 → 前端验证 → API请求 → 后端验证 → 密码加密 → 数据库存储 → 响应
   │          │         │         │         │         │         │
   ▼          ▼         ▼         ▼         ▼         ▼         ▼
表单数据   客户端校验   HTTP POST  服务器校验  BCrypt   用户表    成功/失败
```

### 推文发布流程

```
推文内容 → 认证检查 → 内容验证 → 数据库存储 → 时间线更新 → 通知推送
   │          │         │         │           │           │
   ▼          ▼         ▼         ▼           ▼           ▼
文本输入   JWT验证   长度/内容   推文表     关注者时间线  实时通知
```

### 时间线获取流程

```
用户请求 → 认证验证 → 权限检查 → 数据查询 → 数据聚合 → 响应返回
   │          │         │         │         │         │
   ▼          ▼         ▼         ▼         ▼         ▼
GET请求   JWT解析   用户权限   多表联查   分页排序   JSON响应
```

## 组件交互图

### 核心组件交互

```
┌─────────────────┐
│   控制器层      │
│  UserController │◄─────┐
│ TweetController │      │
│  AuthController │      │
└─────────────────┘      │
         │                │
         ▼                │
┌─────────────────┐      │
│    服务层       │      │
│  UserService    │      │
│ TweetService    │      │
│  AuthService    │      │
└─────────────────┘      │
         │                │
         ▼                │
┌─────────────────┐      │
│   数据访问层    │      │
│ UserRepository  │      │
│TweetRepository  │      │
└─────────────────┘      │
         │                │
         ▼                │
┌─────────────────┐      │
│     数据库      │      │
│   H2/MySQL      │      │
└─────────────────┘      │
                          │
┌─────────────────┐      │
│    安全组件     │──────┘
│  JwtAuthFilter  │
│ SecurityConfig  │
│   JwtUtils      │
└─────────────────┘
```

### 请求处理流程

```
HTTP请求 → Spring MVC → 安全过滤器 → 控制器 → 服务层 → 数据层 → 数据库
    │          │           │          │        │        │        │
    ▼          ▼           ▼          ▼        ▼        ▼        ▼
  客户端   DispatcherServlet JWT过滤器  @Controller @Service @Repository SQL查询
    ▲          ▲           ▲          ▲        ▲        ▲        ▲
    │          │           │          │        │        │        │
HTTP响应 ← JSON序列化 ← 异常处理 ← DTO转换 ← 业务逻辑 ← 实体映射 ← 查询结果
```

## 性能考虑

### 缓存架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用缓存      │    │   分布式缓存    │    │     数据库      │
│  (本地缓存)     │◄──►│    (Redis)      │◄──►│   (MySQL)       │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 数据库优化

```
┌─────────────────────────────────────────────────────────────┐
│                      数据库层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │     索引        │  │   查询优化      │  │   连接池        ││
│  │   - 主键索引    │  │  - 分页查询     │  │  - HikariCP     ││
│  │   - 外键索引    │  │  - 联表优化     │  │  - 连接复用     ││
│  │   - 复合索引    │  │  - 查询缓存     │  │  - 超时设置     ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 监控和日志

### 监控架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用指标      │    │   系统监控      │    │   日志聚合      │
│  (Micrometer)   │───►│  (Prometheus)   │───►│  (ELK Stack)    │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 日志流程

```
应用日志 → Logback → 文件输出 → 日志收集 → 日志分析 → 告警通知
   │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼
业务事件   格式化    日志文件   Filebeat  Elasticsearch 监控告警
```

---

*注意: 这些架构图提供了系统的概览。在实际实现中，可能需要根据具体需求进行调整和优化。*